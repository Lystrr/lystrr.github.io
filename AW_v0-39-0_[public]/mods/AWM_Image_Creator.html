<head>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script type="text/javascript">
    var saveAs = saveAs || navigator.msSaveBlob && navigator.msSaveBlob.bind(navigator) || function (e) {
      "use strict";
      var t = e.document,
        n = function () {
          return e.URL || e.webkitURL || e;
        },
        r = e.URL || e.webkitURL || e,
        i = t.createElementNS("http://www.w3.org/1999/xhtml", "a"),
        s = "download" in i,
        o = function (n) {
          var r = t.createEvent("MouseEvents");
          r.initMouseEvent("click", true, false, e, 0, 0, 0, 0, 0, false, false, false, false, 0, null);
          n.dispatchEvent(r);
        },
        u = e.webkitRequestFileSystem,
        a = e.requestFileSystem || u || e.mozRequestFileSystem,
        f = function (t) {
          (e.setImmediate || e.setTimeout)(function () {
            throw t;
          }, 0);
        },
        l = "application/octet-stream",
        c = 0,
        h = [],
        p = function () {
          var e = h.length;
          while (e--) {
            var t = h[e];
            if (typeof t === "string") {
              r.revokeObjectURL(t);
            } else {
              t.remove();
            }
          }
          h.length = 0;
        },
        d = function (e, t, n) {
          t = [].concat(t);
          var r = t.length;
          while (r--) {
            var i = e["on" + t[r]];
            if (typeof i === "function") {
              try {
                i.call(e, n || e);
              } catch (s) {
                f(s);
              }
            }
          }
        },
        v = function (t, r) {
          var f = this,
            p = t.type,
            v = false,
            m, g, y = function () {
              var e = n().createObjectURL(t);
              h.push(e);
              return e;
            },
            b = function () {
              d(f, "writestart progress write writeend".split(" "));
            },
            w = function () {
              if (v || !m) {
                m = y(t);
              }
              if (g) {
                g.location.href = m;
              } else {
                window.open(m, "_blank");
              }
              f.readyState = f.DONE;
              b();
            },
            E = function (e) {
              return function () {
                if (f.readyState !== f.DONE) {
                  return e.apply(this, arguments);
                }
              };
            },
            S = {
              create: true,
              exclusive: false
            },
            x;
          f.readyState = f.INIT;
          if (!r) {
            r = "download";
          }
          if (s) {
            m = y(t);
            i.href = m;
            i.download = r;
            o(i);
            f.readyState = f.DONE;
            b();
            return;
          }
          if (e.chrome && p && p !== l) {
            x = t.slice || t.webkitSlice;
            t = x.call(t, 0, t.size, l);
            v = true;
          }
          if (u && r !== "download") {
            r += ".download";
          }
          if (p === l || u) {
            g = e;
          }
          if (!a) {
            w();
            return;
          }
          c += t.size;
          a(e.TEMPORARY, c, E(function (e) {
            e.root.getDirectory("saved", S, E(function (e) {
              var n = function () {
                e.getFile(r, S, E(function (e) {
                  e.createWriter(E(function (n) {
                    n.onwriteend = function (t) {
                      g.location.href = e.toURL();
                      h.push(e);
                      f.readyState = f.DONE;
                      d(f, "writeend", t);
                    };
                    n.onerror = function () {
                      var e = n.error;
                      if (e.code !== e.ABORT_ERR) {
                        w();
                      }
                    };
                    "writestart progress write abort".split(" ").forEach(function (e) {
                      n["on" + e] = f["on" + e];
                    });
                    n.write(t);
                    f.abort = function () {
                      n.abort();
                      f.readyState = f.DONE;
                    };
                    f.readyState = f.WRITING;
                  }), w);
                }), w);
              };
              e.getFile(r, {
                create: false
              }, E(function (e) {
                e.remove();
                n();
              }), E(function (e) {
                if (e.code === e.NOT_FOUND_ERR) {
                  n();
                } else {
                  w();
                }
              }));
            }), w);
          }), w);
        },
        m = v.prototype,
        g = function (e, t) {
          return new v(e, t);
        };
      m.abort = function () {
        var e = this;
        e.readyState = e.DONE;
        d(e, "abort");
      };
      m.readyState = m.INIT = 0;
      m.WRITING = 1;
      m.DONE = 2;
      m.error = m.onwritestart = m.onprogress = m.onwrite = m.onabort = m.onerror = m.onwriteend = null;
      e.addEventListener("unload", p, false);
      return g;
    }(self);
    var setup = {};
    setup.itemname = "AWMod-Images";
    setup.version = 1;
    setup.size = 0;
    setup.count = 0;
    setup.waitfor = 0;
    setup.total = 0;
    setup.files = [];
    setup.showpic = true;
    setup.startsize = 0;
    setup.endsize = 0;
    setup.autoadd = true;
    setup.d = {};
    setup.filelist = "<span style='color:deepskyblue;font-size:140%;'>File List:</span>";
    setup.regie = new RegExp(/[a-zA-Z0-9-_]{3,25}\.(jpg|png|gif|jpeg|webp|JPG|PNG|GIF|JPEG)$/);
    setup.regie2 = new RegExp(/[a-zA-Z0-9-_]{3,25}\.(jpeg|webp)$/);
    setup.nameupdate = function () {
      setup.itemname = "AWMod-Images";
      let filename = `${setup.itemname}.awm`;
      $("#filnam").empty().append(filename);
    };
    setup.compile = function () {
      $("#compbutt").empty();
      $("#status").prepend(`. STARTING IMAGE COMPILE<br>`);
      const leng = setup.files.length;
      setup.count = 0;
      setup.waitfor = leng;
      for (let i = 0; i < leng; i++) {
        let fname;
        if (setup.regie2.test(setup.files[i].name)) {
          fname = setup.files[i].name.slice(0, -5);
        } else {
          fname = setup.files[i].name.slice(0, -4);
        }
        setup.readfile(setup.files[i], fname);
      }
    };
    setup.format = function () {
      const keys = Object.keys(setup.d);
      const le = keys.length;
      $("#status").prepend(`. Formatting Data... ${le} files.<br>`);
      let data = `{"images": {`;
      let n = 0;
      for (let i = 0; i < le; i++) {
        data += `"${keys[i]}":"${setup.d[keys[i]]}"`;
        if(i != (le - 1)){
          data += ",";
        }
        n++;
        $("#status").prepend(`...${(i+1)} of ${le}<br>`);
      }
      data += "}}";
      $("#status").prepend(`... Saving file "${setup.itemname}.awm".<br>`);
      setup.save(data);
      setup.version = 1;
      setup.size = 0;
      setup.count = 0;
      setup.waitfor = 0;
      setup.total = 0;
      setup.files = [];
      setup.d = {};
      let sts = setup.startsize;
      let ens = setup.endsize;
      setup.startsize = 0;
      setup.endsize = 0;
      setup.basesize = 0;
      sts = sts + Math.round(sts / 24);
      let sizo = Math.round((ens / sts) * 100) - 100;
      setup.filelist = "<span style='color:deepskyblue;font-size:140%;'>File List:</span>";
      $("#counter").empty().append(`zero`);
      $("#filelist").empty().append(setup.filelist);
      $("#status").prepend(`. FINISHED! size increase: ${sizo}%`);
    };
    async function cunt() {
      setup.count += 1;
      console.log(`cunt was triggered: ${setup.count} of ${setup.waitfor}`);
      if (setup.count >= setup.waitfor) {
        console.log(`Done converting!`);
        setup.format();
      }
    }
    setup.toggler = function () {
      if (document.getElementById("showimgcheck").checked) {
        setup.showpic = true;
      } else {
        setup.showpic = false;
      }
    };
    setup.toggler2 = function () {
      if (document.getElementById("autoadd").checked) {
        setup.autoadd = true;
      } else {
        setup.autoadd = false;
      }
    };
    setup.runamajig = function() {
      if(setup.autoadd){
        setup.addfiles();
      }
    }
    setup.readfile = function (file, fname) {
      var reader = new FileReader();
      reader.readAsDataURL(file);
      reader.onload = function () {
        setup.d[fname] = reader.result;
        var blob = new Blob([reader.result], {
          type: "text/plain;charset=utf-8"
        });
        setup.endsize += blob.size;
        if (setup.showpic) {
          let siz = Math.floor(blob.size / 1000) + "KB";
          let prin = `<div class="tit2" style="background-image:url(${reader.result});">${fname}<br>${siz}</div>`;
          $("#status").prepend(prin);
        }
        cunt();
      };
      reader.onerror = function (error) {
        $("#status").prepend(`. <span style="color:#fc4e4e;">A file failed because of: ${error}</span><br>`);
        cunt();
      };
    };
    setup.save = function (data) {
      let obData, filename = `${setup.itemname}.awm`;
      /*try {
        obData = setup.AW.code.compressToUTF16(data);
      } catch (e) {
        alert(`Unable to compress data. ${e.name}: ${e.message}.`);
      }*/
      var blob = new Blob([data], {
        type: "text/plain;charset=utf-8"
      });
      try {
        saveAs(blob, filename);
      } catch (e) {
        alert(`Unable to save file. ${e.name}: ${e.message}.`);
      }
    };
    setup.addfiles = function () {
      let value = document.getElementById('fileselector').files;
      let c = value.length,
        msg = "Adding Files: ";
      let cnt = c;
      for (let i = 0; i < c; i++) {
        if (setup.regie.test(value[i].name)) {
          setup.files.push(value[i]);
          setup.filelist += (i == 0) ? "<br>>" : ", ";
          setup.filelist += value[i].name;
          setup.size += value[i].size;
        } else {
          cnt -= 1;
          msg += `...<span style="color:#fc4e4e;">${value[i].name}: invalid type or name!</span> `;
        }
      }
      msg += `...Added ${cnt} files to compile list.<br>`;
      setup.total += cnt;
      let si = Math.round(setup.size / 975);
      if (si >= 1000) {
        let sd = Math.round(si / 100) % 10;
        let sdd = Math.round(si / 10) % 10;
        si = Math.floor(si / 1000) + "." + sd + sdd + "MB";
      } else {
        si += "KB";
      }
      let ch = `${setup.total} (${si})`;
      setup.startsize += setup.size;
      $("#counter").empty().append(ch);
      $("#status").prepend(msg);
      $("#filelist").empty();
      $("#filelist").append(setup.filelist);
      //alert(msg);
      if (cnt > 0) {
        let butt =
          `<input type="button" id="compile" value="COMPILE" onclick="setup.compile()" style="font-size:120%;color:#000;background-color:deepskyblue;padding:5px;border-radius:5px;margin:10px;">`;
        $("#compbutt").empty().append(butt);
      }
    };
    setup.testfile = function () {
      $("#status").prepend(`... Starting Test.<br>`);
      var value = document.getElementById('fileselector').files[0];
      $.getScript( value )
        .done(function( script, textStatus ) {
          processFile();
        })
        .fail(function( jqxhr, settings, exception ) {
          alert( "Triggered ajaxError handler." );
      });
    };

    function processFile() {
      let dataNames = ["AWprimary","Ainfo","Binterface","Cmisc","Dmap","Eassets","Fportrait"];
      let namer = "none"
      for(let i = 1, c = dataNames.length; i < c; i++){
        if(window[dataNames[i]] !== null && window[dataNames[i]] !== undefined){
          namer = dataNames[i];
        }
      }
      if(namer == "none"){
        alert("No valid data found!");
        return;
      }
      var file = window[namer];
      $("#filelist").empty();
      let keys = Object.keys(file);
      $("#status").prepend(`... successful decompress, found ${(keys.length-2)} images.<br>`);
      let ver = "unknown", cunter = "error";
      let prin = "";
      for (let i = 0, c = keys.length; i < c; i++) {
        if(keys[i] !== "imgCount" && keys[i] !== "fVer"){
          prin += `<div class="tit" style="background-image:url(${file[keys[i]]});"><b>${i}</b><br>${keys[i]}</div>`;
        }else if(keys[i] === "imgCount"){
          cunter = file[keys[i]];
        }else if(keys[i] === "fVer"){
          ver = file[keys[i]];
        }
        if (i % 8 == 0) {
          prin += `⮘${i}<br><br>`;
        }
      }
      $("#filelist").append(`<h2>Images:</h2><h3>Version: ${ver}, Images: ${cunter}`);
      $("#filelist").append(prin);
    }

    function uploadButton(filename) {
      var reader = new FileReader();
      var textFile = filename;
      reader.readAsText(textFile);
      $(reader).on('load', processFile);
    }
  </script>
  <script type="text/javascript">
    //document.addEventListener?document.addEventListener("contextmenu",function(e){e.preventDefault()},!1):document.attachEvent("oncontextmenu",function(){window.event.returnValue=!1});
  </script>
  <style>
    body {
      background: #222222;
      color: #CCCCCC;
      font-size: 18px;
      font-family: monospace;
    }

    h1 {
      margin: 5px;
    }

    .tit {
      position: relative;
      display: inline-block;
      width: 75px;
      height: 75px;
      font-family: monospace;
      font-size: 10px;
      color: #FFFFFF;
      overflow: hidden;
      border-color: #CCCCCC;
      border-width: 1px;
      border-style: solid;
      background-size: auto 100%;
      background-position: center;
      background-repeat: no-repeat;
      word-break: break-all;
      font-weight: 600;
      text-shadow: #222222;
    }

    .tit:hover {
      width: 150px;
      height: 150px;
      font-size: 20px;
      font-weight: 900;
      color: rgb(128, 255, 0);
      word-break: break-all;
    }

    .tit2 {
      position: relative;
      display: inline-block;
      width: 70px;
      height: 50px;
      font-family: monospace;
      font-size: 10px;
      color: #FFFFFF;
      overflow: hidden;
      border-color: #CCCCCC;
      border-width: 1px;
      border-style: solid;
      background-size: auto 100%;
      background-position: center;
      background-repeat: no-repeat;
      word-break: break-all;
      font-weight: 900;
      text-shadow: #222222;
    }

    .controls {
      border-color: #BBBBBB;
      border-width: 3px;
      border-radius: 10px;
      border-style: solid;
      position: fixed;
      padding: 0;
      left: 10px;
      top: 5px;
      width: 50%;
      height: 97%;
    }

    .cunt {
      border: none;
      position: relative;
      width: 95%;
      margin: auto;
    }

    .filelist {
      border-color: #999999;
      border-style: dotted;
      border-width: 3px;
      border-radius: 10px;
      position: fixed;
      right: 10px;
      top: 5px;
      width: 47%;
      height: 97%;
      overflow-y: auto;
    }

    .status {
      border-color: #999999;
      border-width: 3px;
      border-radius: 10px;
      border-style: dashed;
      position: absolute;
      padding: 5px;
      left: 5px;
      top: 420px;
      bottom: 5px;
      right: 5px;
      overflow-y: auto;
    }

    .instructions {
      border-color: deepskyblue;
      border-width: 2;
      border-style: solid;
      border-radius: 0px;
      position: relative;
      width: 95%;
      height: 175px;
      margin: auto;
      margin-top: 5px;
      margin-bottom: 10px;
      padding: 7px;
      text-align: justify;
      overflow-x: hidden;
      overflow-y: auto;
      color: #EEEEEE;
      font-family: Helvetica, Arial, sans-serif
    }
  </style>
</head>

<body>
  <div id="controls" class="controls">
    <div style="color:deepskyblue;margin:auto;text-align:center;">
      <h1>Accidental Woman AWM Image Compiler
        <span style="font-size:50%"></span>
      </h1>
    </div>
    <div class="instructions">
      <span style="color:deepskyblue;">AWM Image Compiler Version 1.1 (© ThaumX 2018)</span>
      <br>
      <br>
      <span style="color:coral;font-size:120%">
        <b>Instructions:</b> (read me!)</span>
      <br> use the file selection to select one or more images to add to the .awm file. You can use the file selection box to add images multiple times before compiling. If you mess up and add
      the wrong image/s, refresh the page to start over.
      <br>
      <br>When you are done selecting files, click the COMPILE button to compile the images into an awm file. By default, the files will be named AWMod-Images.awm, you can rename them (and should, if publishing it).
      <br>
      <br>
      <b>Show Images:</b> whether to display the images during the process to confirm they were encoded properly.
      <br>
      <b>Auto-Add</b> When selecting files from the browser they will be automatically added, meaning you don't need to click "ADD TO LIST". Useful for images in multiple locations, but if you make a mistake you'll have to start over with adding images.
      <br>
      <br> 
      <i>Note that simply adding random images won't add them to the game. They must be expected by the game to be displayed
        at this time.</i>
      <br>
      <br>
      <b>To test an AWM file:</b> select a single awm file using the file selector, and click the TEST button. The awm file
      will be loading, and contained images will be shown in the file list area.
      <br>
      <br>
      <span style="color:rgb(198, 59, 59)">Supported files: .jpg (& .jpeg) .png .gif .webp
        <br>Image file names must be alphanumeric (- and _ are allowed).</span>
      <br>
      <br>
      <b>
        <span style="color:deepskyblue;">Please be patient while the program works!</span>
      </b>
      <br>
      <br>
      <i>Only limited support is offered for this tool. It is completely functional, so if you're having problems please read
        the instructions again and use it in an up-to-date browser. Trying to use this tool on a mobile device will likely
        be slow and painful. If you have an idea for features/improvements, shoot it my way.</i>
      <br>
    </div>
    <div class="cunt">
      Show Images:
      <input type="checkbox" id="showimgcheck" name="showimgcheck" onchange="setup.toggler()" checked=true>
      Auto-Add:
      <input type="checkbox" id="autoadd" name="autoadd" onchange="setup.toggler2()" checked=true>
      filename:
      <span id="filnam" style="font-size:90%;color:deepskyblue;">AWMod-Images.awm</span> (rename-able) Total:
      <span id="counter" style="color:deepskyblue;font-size:115%;">0</span>
      <br>
      <br> File Select: </span>
      <input type=file id="fileselector" name="fileselector" onchange="setup.runamajig()" multiple>
      <input type=button value="ADD TO LIST" onclick="setup.addfiles()">
      <input type=button value="TEST"> <span style="font-size:80%;"><i>(Test function isn't finished!)</i></span>
      <br>
      <div id="compbutt" style="text-align: center;">
        <span style="font-size:110%;color:#999999;">
          <br>
          <i>Add file/s to compile!</i>
        </span>
      </div>
    </div>
    <div id="status" class="status">
      <span style="color:deepskyblue;font-size:120%;">Output:</span>
    </div>
  </div>
  <div id="filelist" class="filelist">
    <h2 style="color:deepskyblue;">File List:</h2>
  </div>

</body>